<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>AutoPolicy – Document {{ document.id }}</title>

    <!-- Main shared CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Chart.js for the per-document chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="page">
        <!-- Top bar / header -->
        <header class="top-bar">
            <div class="logo">
                AutoPolicy
            </div>
            <div class="top-bar-right">
                <span class="top-bar-subtitle">Legal Risk Analyzer</span>
                <a href="{{ url_for('index') }}" class="btn btn-secondary small-btn">
                    ← Back to dashboard
                </a>
            </div>
        </header>

        <main class="main-content">
            <!-- Document summary card -->
            <section class="card">
                <h1>Document details</h1>

                <div class="doc-meta-grid">
                    <div>
                        <div class="label">Filename</div>
                        <div class="value">{{ document.original_filename }}</div>
                    </div>
                    <div>
                        <div class="label">Total clauses</div>
                        <div class="value">{{ document.total_clauses or 0 }}</div>
                    </div>
                    <div>
                        <div class="label">Risky clauses</div>
                        <div class="value">{{ document.risky_clauses or 0 }}</div>
                    </div>
                    <div>
                        <div class="label">Risk %</div>
                        <div class="value">
                            {% if document.total_clauses %}
                                {{ (document.risky_clauses * 100.0 / document.total_clauses) | round(2) }}
                            {% else %}
                                0.00
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <div class="label">Rating</div>
                        <div class="badge badge-rating">
                            {{ document.overall_rating or "-" }}
                        </div>
                    </div>
                </div>
            </section>

            <!-- Chart + summary -->
            <section class="card">
                <h2>Risk distribution</h2>

                <div class="chart-wrapper single-chart">
                    <canvas id="riskPie"></canvas>
                </div>

                <p class="helper-text">
                    Shows how risky clauses in this document are distributed by category.
                </p>
            </section>

            <!-- Risky clauses list -->
            <section class="card">
                <h2>Risky clauses (detailed view)</h2>

                {% if risky_clauses and risky_clauses|length > 0 %}
                    <ol class="clause-list">
                        {% for c in risky_clauses %}
                            <li class="clause-item">
                                <div class="clause-header">
                                    <span class="clause-id">
                                        Clause {{ c.clause_number }}
                                    </span>
                                    <span class="clause-score">
                                        Score: {{ c.model_risk_score }}
                                    </span>
                                    <span class="clause-tags">
                                        {{ c.model_risk_reason }}
                                    </span>
                                </div>
                                <p class="clause-text">
                                    {{ c.text }}
                                </p>
                            </li>
                        {% endfor %}
                    </ol>
                {% else %}
                    <p>No risky clauses were detected in this document by the current rules.</p>
                {% endif %}

                <p class="helper-text">
                    This is a helper tool. Final responsibility always stays with the document owner / client.
                </p>
            </section>
        </main>
    </div>

    <!-- Fancy doughnut chart (visual only, logic unchanged) -->
    <script>
        (function () {
            var canvas = document.getElementById("riskPie");
            if (!canvas) {
                return;
            }

            var ctx = canvas.getContext("2d");

            // Data from Flask (same as before)
            var labels = [
                {% for r in risk_distribution %}
                    "{{ r.risk_type }}"{% if not loop.last %}, {% endif %}
                {% endfor %}
            ];

            var values = [
                {% for r in risk_distribution %}
                    {{ r.risky_clauses }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            ];

            // If there is no risk data, show a neutral single slice
            if (!labels.length) {
                labels = ["no_risk"];
                values = [1];
            }

            // Total for percentage display in tooltip
            var totalValue = values.reduce(function (a, b) { return a + b; }, 0);

            // Color palette per risk type (presentation only)
            var colorByType = {
                data_sharing:   "#f97373",  // soft red
                account_closure:"#fb923c",  // orange
                indemnity:      "#facc15",  // yellow
                generic_risk:   "#38bdf8",  // light blue
                fees_charges:   "#a855f7"   // purple
            };

            var fallbackColors = [
                "#f97373", "#fb923c", "#facc15",
                "#38bdf8", "#22c55e", "#a855f7",
                "#ec4899", "#0ea5e9"
            ];

            var backgroundColors = labels.map(function (name, idx) {
                var key = (name || "").toLowerCase().replace(/\s+/g, "_");
                return colorByType[key] || fallbackColors[idx % fallbackColors.length];
            });

            new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: "#020617",
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "65%",
                    plugins: {
                        legend: {
                            position: "bottom",
                            labels: {
                                usePointStyle: true,
                                pointStyle: "circle",
                                padding: 16,
                                color: "#e5e7eb",
                                font: {
                                    size: 12,
                                    family: "system-ui, -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: "rgba(15,23,42,0.95)",
                            padding: 10,
                            displayColors: true,
                            callbacks: {
                                label: function (ctx) {
                                    var label = ctx.label || "";
                                    var value = ctx.parsed || 0;
                                    var pct = totalValue
                                        ? ((value * 100) / totalValue).toFixed(1)
                                        : 0;
                                    return label + ": " + value + " clauses (" + pct + "%)";
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        })();
    </script>
</body>
</html>